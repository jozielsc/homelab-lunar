- name: Instalando K3S no MASTER
  vars:
    SERVER_MAIN_IP: '10.10.30.100'
    TOKEN: 'c1ust3rk3s1oc41bui1d3r'
  hosts: SERVER_MAIN
  tasks:
    - name: -> SERVER - Instalando o K3S
      shell: |
        curl -sfL https://get.k3s.io | sh -s - server \
        --node-ip {{ SERVER_MAIN_IP }} \
        --disable=flannel,local-storage,metrics-server,servicelb,traefik \
        --flannel-backend='none' \
        --disable-network-policy \
        --disable-cloud-controller \
        --disable-kube-proxy \
        --token {{ TOKEN }} \
        --write-kubeconfig-mode 644 
      register: k3s_install
      ignore_errors: no 

    - name: Lendo k3s server token
      ansible.builtin.slurp:
        src: /var/lib/rancher/k3s/server/node-token
      register: k3s_server_token
      ignore_errors: no    

    - name: prepare token to servers 
      set_fact: 
        k3s_token: "{{ k3s_server_token['content'] | b64decode | trim }}"
    
    - name: -> SERVER - Acessar o arquivo de configuração do K3S
      shell: cat /etc/rancher/k3s/k3s.yaml
      register: k3s_cfg
      ignore_errors: no 
    
    - name: -> SERVER - Copiar o arquivo de configuração do k3s 
      delegate_to: localhost
      copy:
        content: "{{ k3s_cfg.stdout }}"
        dest: "{{ playbook_dir }}/k3s.cfg.yaml"
      ignore_errors: no

- name: NODES - Instalando K3s nos NODES
  hosts: NODES
  vars:
    SERVER_MAIN_IP: '10.10.30.100'
  tasks:
    - name: -> NODE - INSTALL K3S 
      shell: |
        curl -sfL https://get.k3s.io | sh -s - agent \
        --server https://{{ SERVER_MAIN_IP }}:6443 \
        --token {{ hostvars['k3s1'].k3s_token }}
      register: k3s_install 
      ignore_errors: no
